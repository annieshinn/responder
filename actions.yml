flows:
  - rule: NonCompliantUserCreated
    enabled: true
    sequential:
      - command: SendSlack
        message:
          values:
            - label: "Created username"
              value: "$.event.detail.requestParameters.userName"
            - label: "IP address"
              value: "$.event.detail.sourceIPAddress"
            - label: "Initiating user"
              value: "$.event.detail.userIdentity.userName"
      - command: SendEmail
      - command: Wait
        duration: 10
      - rule: check
      - command: SendSlack
        message:
          header: "Will remove non-compliant user"
          values:
            - label: "Removing username"
              value: "$.event.detail.requestParameters.userName"
      - rule: remediate
      - command: SendSlack
        message: "Non-compliant user removed"

  - rule: UnauthorizedInstanceCreated
    sequential:
      - command: SendSlack
        message:
          values:
            - label: "Created instances"
              value: "$.event.detail.responseElements.instancesSet.items[*].instanceId"
            - label: "IP address"
              value: "$.event.detail.sourceIPAddress"
            - label: "Initiating user"
              value: "$.event.detail.userIdentity.userName"
      - command: SendEmail
      - command: Wait
        duration: 120
      - rule: check
      - command: SendSlack
        message: "Will terminate instances"
      - rule: remediate

  - rule: SuspiciousLoginHour
    parallel:
      - command: SendSlack
        message:
          values:
            - label: "Account"
              value: "$.event.account"
            - label: "Username"
              value: "$.event.detail.userIdentity.principalId"
            - label: "IP address"
              value: "$.event.detail.sourceIPAddress"
      - command: SendEmail

  - rule: SuspiciousLoginIP
    enabled: true
    parallel:
      - command: SendSlack
        message:
          values:
            - label: "Account"
              value: "$.event.account"
            - label: "Username"
              value: "$.event.detail.userIdentity.principalId"
            - label: "IP address"
              value: "$.event.detail.sourceIPAddress"
      - command: SendEmail

  - rule: RootLogin
    enabled: true
    parallel:
      - command: SendSlack
        message:
          header: ":bomb: Root has logged in"
          values:
            - label: "Account"
              value: "$.event.account"
            - label: "IP address"
              value: "$.event.detail.sourceIPAddress"
      - command: SendEmail
        subject: "Root has logged in!"


  # - rule: "@raphbot/instanceCreated"
  #   instanceType: "t2.micro"