service: cloud-responder
configValidationMode: error
custom:
  defaultRegion: us-east-1

provider:
  name: aws
  stage: dev
  runtime: nodejs14.x
  memorySize: 128
  versionFunctions: false
  lambdaHashingVersion: 20201221
  region: ${opt:region, self:custom.defaultRegion}
  environment:
    EMAIL_TOPIC_ARN: !Ref "EmailTopic"

  iam:
   role:
    statements:
      - Effect: Allow
        Action:
          - secretsmanager:GetSecretValue
        Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:CloudResponderSecret*"
      - Effect: Allow
        Action:
          - sns:Publish
        Resource:
          - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:dispatch"
          - !Ref "EmailTopic"
      - Effect: Allow
        Action:
          - iam:DeleteUser
          - iam:ListAccessKeys
          - iam:DeleteAccessKey
          - iam:GetLoginProfile
          - iam:GetUser
          - iam:DeleteLoginProfile
        Resource: "*"
      - Effect: Allow
        Action:
          - ec2:DescribeInstanceStatus
          - ec2:DescribeInstances
          - ec2:TerminateInstances
        Resource: "*"

functions:
  authorizer:
    handler: serverless.authorizer
    timeout: 30
  capture:
    handler: serverless.capture
    timeout: 30
    events:
      - http:
          path: capture
          method: post
          authorizer:
            name: authorizer
            resultTtlInSeconds: 0
            identitySource: method.request.header.APIKey

  process:
    handler: serverless.process
    timeout: 900
    events:
      - sns: dispatch

resources:
  Resources:
    EmailTopic:
      Type: AWS::SNS::Topic
      Properties:
        Subscription:
          - Endpoint: "xabi@keinu.net"
            Protocol: "email"
        TopicName: "EmailTopic"
      # EmailSubscription:
      #   Type: AWS::SNS::Subscription
      #   Properties:
      #     Endpoint: xabi@keinu.net
      #     Protocol: email
      #     TopicArn: !Ref 'EmailTopic'